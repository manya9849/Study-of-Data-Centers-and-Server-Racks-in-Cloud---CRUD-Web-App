<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Servers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5">

    <h2 class="mb-4 text-center">
        <i class="bi bi-hdd-stack text-primary"></i> Server Management
    </h2>

    <!-- Add Server Card -->
    <div class="card p-4 shadow-sm mb-4">
        <h4><i class="bi bi-plus-circle text-success"></i> Add Server</h4>

        <form id="add-server-form">
    <label class="form-label mt-2">Server Name:</label>
    <input type="text" class="form-control" id="server-name" required>

    <label class="form-label mt-3">Select Rack:</label>
    <select class="form-select" id="rack-id" required>
        {% for r in racks %}
            <option value="{{ r[0] }}">{{ r[1] }}</option>
        {% endfor %}
    </select>

    <label class="form-label mt-3">CPU Usage (%):</label>
    <input type="number" id="cpu-usage" min="0" max="100" class="form-control" required>

    <label class="form-label mt-3">Temperature (°C):</label>
    <input type="number" id="temperature" class="form-control" required>

    <label class="form-label mt-3">Status:</label>
    <select class="form-select" id="status">
        <option value="Normal">Normal</option>
        <option value="Overheating">Overheating</option>
    </select>

    <button class="btn btn-primary mt-3">
        <i class="bi bi-save"></i> Add Server
    </button>
</form>

    </div>

    <!-- Servers Table -->
    <table class="table table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>CPU</th>
                <th>Temp</th>
                <th>Status</th>
                <th>Rack</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
        {% for s in data %}
            <tr>
                <td>{{ s[0] }}</td>
                <td>{{ s[1] }}</td>
                <td>{{ s[2] }}%</td>
                <td>{{ s[3] }}°C</td>

                <td>
                    {% if s[4] == "Overheating" %}
                        <span class="badge bg-danger">{{ s[4] }}</span>
                    {% else %}
                        <span class="badge bg-success">{{ s[4] }}</span>
                    {% endif %}
                </td>

                <td>{{ s[5] }}</td>

                <td>

                    <!-- Edit Button -->
                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal"
                            data-bs-target="#editModal{{ s[0] }}">
                        <i class="bi bi-pencil-square"></i>
                    </button>

                    <!-- Delete Button -->
                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                            data-bs-target="#deleteModal{{ s[0] }}">
                        <i class="bi bi-trash"></i>
                    </button>

                </td>
            </tr>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal{{ s[0] }}" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">

                  <div class="modal-header">
                    <h5 class="modal-title">Edit Server</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <form action="/servers/edit/{{ s[0] }}" method="POST">
                    <div class="modal-body">

                      <label class="form-label">Server Name</label>
                      <input type="text" class="form-control" name="server_name" value="{{ s[1] }}" required>

                      <label class="form-label mt-2">Select Rack</label>
                      <select name="rack_id" class="form-select">
                        {% for r in racks %}
                          <option value="{{ r[0] }}" {% if r[0] == s[6] %}selected{% endif %}>
                              {{ r[1] }}
                          </option>
                        {% endfor %}
                      </select>

                      <label class="form-label mt-2">CPU Usage (%)</label>
                      <input type="number" class="form-control" name="cpu_usage" value="{{ s[2] }}" required>

                      <label class="form-label mt-2">Temperature</label>
                      <input type="number" class="form-control" name="temperature" value="{{ s[3] }}" required>

                      <label class="form-label mt-2">Status</label>
                      <select name="status" class="form-select">
                          <option value="Normal" {% if s[4]=="Normal" %}selected{% endif %}>Normal</option>
                          <option value="Overheating" {% if s[4]=="Overheating" %}selected{% endif %}>Overheating</option>
                      </select>

                    </div>

                    <div class="modal-footer">
                      <button class="btn btn-success">Save Changes</button>
                    </div>

                  </form>

                </div>
              </div>
            </div>

            <!-- Delete Modal -->
            <div class="modal fade" id="deleteModal{{ s[0] }}" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">

                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                    Are you sure you want to delete <b>{{ s[1] }}</b>?
                  </div>

                  <div class="modal-footer">
                    <a href="/servers/delete/{{ s[0] }}" class="btn btn-danger">Delete</a>
                  </div>

                </div>
              </div>
            </div>

        {% endfor %}
        </tbody>

    </table>

    <a href="/" class="btn btn-secondary mt-3">
        <i class="bi bi-arrow-left"></i> Back to Home
    </a>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
<script>
document.getElementById('add-server-form').addEventListener('submit', async function(e){
    e.preventDefault();
    const server_name = document.getElementById('server-name').value;
    const rack_id = document.getElementById('rack-id').value;
    const cpu_usage = document.getElementById('cpu-usage').value;
    const temperature = document.getElementById('temperature').value;
    const status = document.getElementById('status').value;

    const res = await fetch('/api/add_server', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ server_name, rack_id, cpu_usage, temperature, status })
    });

    const data = await res.json();
    if(data.status === "success"){
        const tbody = document.querySelector('table tbody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${data.id}</td>
            <td>${data.server_name}</td>
            <td>${data.cpu_usage}%</td>
            <td>${data.temperature}°C</td>
            <td>${data.status === 'Overheating' ? '<span class="badge bg-danger">Overheating</span>' : '<span class="badge bg-success">Normal</span>'}</td>
            <td>${document.getElementById('rack-id').selectedOptions[0].text}</td>
            <td>
                <a href="/servers/delete/${data.id}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">
                    <i class="bi bi-trash"></i> Delete
                </a>
            </td>
        `;
        tbody.appendChild(row);

        // Clear form
        document.getElementById('server-name').value = '';
        document.getElementById('cpu-usage').value = '';
        document.getElementById('temperature').value = '';
        document.getElementById('status').value = 'Normal';
    }
});
</script>

</html>
